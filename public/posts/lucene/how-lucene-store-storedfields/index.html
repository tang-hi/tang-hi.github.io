<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
<meta charset="UTF-8">

<script async src="https://www.googletagmanager.com/gtag/js?id=G-D5M6G40M25"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-D5M6G40M25');
</script>
<meta name="baidu-site-verification" content="codeva-vs6hGikUak" />
<title>How Lucene Stores Its Forward Index | Don&#39;t Panic</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.123.7">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="This article will introduce how Lucene 9.6 stores its forward index, to help readers better understand its internal workings.">
<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.css" />
<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
<link rel="stylesheet" type="text/css" media="screen" href="/css/all.css" /><link rel="stylesheet" href="/css/katex.css" crossorigin="anonymous">
<script defer src="/js/katex.js"  integrity="sha384-PFWG8XW41D5NzhNv5FegM1CUkw9nNLdWug8DuwnUoNEVop9n5frjcnbtsZtxTNjw" crossorigin="anonymous"></script>
<script defer src="/js/auto-render.js" integrity="sha384-EN2q+JG5/3Z8gD7hT5WZqq+W+9wQR4P3IezfuZmGG5RkNXaaaks85seDJO7WkZlY" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script>
document.addEventListener("DOMContentLoaded", function() { renderMathInElement(document.body, { delimiters: [ {left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false} ] }); });
</script>




<meta property="og:title" content="How Lucene Stores Its Forward Index" />
<meta property="og:description" content="This article will introduce how Lucene 9.6 stores its forward index, to help readers better understand its internal workings." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/lucene/how-lucene-store-storedfields/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-23T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-05-23T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="How Lucene Stores Its Forward Index"/>
<meta name="twitter:description" content="This article will introduce how Lucene 9.6 stores its forward index, to help readers better understand its internal workings."/>

<meta itemprop="name" content="How Lucene Stores Its Forward Index">
<meta itemprop="description" content="This article will introduce how Lucene 9.6 stores its forward index, to help readers better understand its internal workings."><meta itemprop="datePublished" content="2023-05-23T00:00:00+00:00" />
<meta itemprop="dateModified" content="2023-05-23T00:00:00+00:00" />
<meta itemprop="wordCount" content="2306">
<meta itemprop="keywords" content="" />
</head>
<body>
<header>
<div id="avatar">
<a href="http://localhost:1313/"><img src="/avatar.jpeg" alt="Don&#39;t Panic"></a>
</div>
<div id="titletext">
<h2 id="titleonly"><a href="http://localhost:1313/">Don&#39;t Panic</a></h2>
</div>
<div id="title-social">
<div id="social">
<nav><ul>
<li><a href="https://github.com/tang-hi"><i title="Github" class="icons fab fa-github"></i></a></li>
<li><a href="mailto:tangdhcs@gmail.com"><i title="Email" class="icons fas fa-envelope"></i></a></li>
<li><a href="https://twitter.com/TangDh"><i title="Twitter" class="icons fab fa-twitter"></i></a></li>
<li><a href="/index.xml"><i title="RSS" class="icons fas fa-rss"></i></a></li>
<li><a><i title="Switch Dark Mode" class="dark-mode icons fas fa-moon"></i></a></li>
</ul></nav>
</div>
</div>
<div id="mainmenu">
<nav>
<ul>
<li><a href="/">Home</a></li>
<li><a href="/posts">All Posts</a></li>
<li><a href="/about">About</a></li>
<li><a href="/categories">Categories</a></li>
</ul>
</nav>
</div>
</header>
<main>
<div class="post">
<article>
<div class="post-header">
<div class="meta">
<div class="date">
<span class="day">23</span>
<span class="rest">May 2023</span>
</div>
</div>
<div class="matter">
<h1 class="title">How Lucene Stores Its Forward Index</h1>
<p class="post-meta">
<span class="post-meta">

&nbsp;<i class="fas fa-clock"></i>&nbsp;11&nbsp;minutes


 
&nbsp;| &nbsp;

<i class="fas fa-book"></i>&nbsp;2306&nbsp;words




</span>

</p>
</div>
</div>
<div class="markdown">
<p>This article will introduce how Lucene 9.6 stores its forward index, to help readers better understand its internal workings.</p>
<p>A forward index, also known as a direct index, is a basic data structure in information retrieval systems. It stores the content and attributes of each document in the order of the documents, allowing the system to quickly access detailed information of any specified document. In Lucene, the storage mechanism of forward data is one of the key factors enabling it to efficiently perform full-text searches.</p>
<p>Since the main focus of this article is the storage format of the forward index on the disk, the preprocessing of the document and how the <code>docID</code> is obtained will be ignored.</p>
<h2 id="what-is-a-forward-index">What is a Forward Index</h2>
<p>Simply put, a forward index is a structure that allows querying the corresponding document through <code>docID</code>. We can compare it to a key-value pair, where <code>docID</code> is the key and the document content is the value.</p>
<div style="text-align: center">
<img src="/pic/lucene-forward/doc-first.png"/>
</div>
<p>Therefore, the layout of Lucene&rsquo;s forward index on the disk must allow quick location of the document content through <code>docID</code>.</p>
<h2 id="building-the-forward-index">Building the Forward Index</h2>
<p>The entry function for building the forward index is <code>IndexingChain#processDocument</code> (Lucene refers to the forward index as StoredFields).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">processDocument</span>(<span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>docID,<span style="color:#bbb"> </span>Iterable<span style="color:#333">&lt;?</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">extends</span><span style="color:#bbb"> </span>IndexableField<span style="color:#333">&gt;</span><span style="color:#bbb"> </span>document)<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">   	
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>startStoredFields(docID);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">	  </span><span style="color:#888">// skip .....</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>docFieldIdx<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">for</span><span style="color:#bbb"> </span>(IndexableField<span style="color:#bbb"> </span>field<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>document)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#080;font-weight:bold">if</span><span style="color:#bbb"> </span>(processField(docID,<span style="color:#bbb"> </span>field,<span style="color:#bbb"> </span>docFields<span style="color:#333">[</span>docFieldIdx<span style="color:#333">]</span>))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>fields<span style="color:#333">[</span>indexedFieldCount<span style="color:#333">]</span><span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>docFields<span style="color:#333">[</span>docFieldIdx<span style="color:#333">]</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>indexedFieldCount<span style="color:#333">++</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>docFieldIdx<span style="color:#333">++</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">finally</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">if</span><span style="color:#bbb"> </span>(hasHitAbortingException<span style="color:#bbb"> </span><span style="color:#333">==</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">false</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      	</span><span style="color:#888">// skip ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#888">// finish forward index</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>finishStoredFields();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#888">// skip ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>If we only focus on the processing of the forward index, we will find that Lucene does three things for the forward index:</p>
<ol>
<li>Initialization based on <code>docID</code>.</li>
<li>Processing each field in the document.</li>
<li>Finalizing the forward index for this document.</li>
</ol>
<p>If we are only interested in how the index is stored on the disk, we only need to pay attention to the last two points.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#080;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">boolean</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">processField</span>(<span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>docID,<span style="color:#bbb"> </span>IndexableField<span style="color:#bbb"> </span>field,<span style="color:#bbb"> </span>PerField<span style="color:#bbb"> </span>pf)<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">// skip....</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">// Add stored fields</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">if</span><span style="color:#bbb"> </span>(fieldType.<span style="color:#00c">stored</span>())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>StoredValue<span style="color:#bbb"> </span>storedValue<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>field.<span style="color:#00c">storedValue</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">if</span><span style="color:#bbb"> </span>(storedValue<span style="color:#bbb"> </span><span style="color:#333">==</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">null</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#080;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">new</span><span style="color:#bbb"> </span>IllegalArgumentException(<span style="background-color:#fff0f0">&#34;Cannot store a null value&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">else</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">if</span><span style="color:#bbb"> </span>(storedValue.<span style="color:#00c">getType</span>()<span style="color:#bbb"> </span><span style="color:#333">==</span><span style="color:#bbb"> </span>StoredValue.<span style="color:#00c">Type</span>.<span style="color:#00c">STRING</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#333">&amp;&amp;</span><span style="color:#bbb"> </span>storedValue.<span style="color:#00c">getStringValue</span>().<span style="color:#00c">length</span>()<span style="color:#bbb"> </span><span style="color:#333">&gt;</span><span style="color:#bbb"> </span>IndexWriter.<span style="color:#00c">MAX_STORED_STRING_LENGTH</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#080;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">new</span><span style="color:#bbb"> </span>IllegalArgumentException(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="background-color:#fff0f0">&#34;stored field \&#34;&#34;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#333">+</span><span style="color:#bbb"> </span>field.<span style="color:#00c">name</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#333">+</span><span style="color:#bbb"> </span><span style="background-color:#fff0f0">&#34;\&#34; is too large (&#34;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#333">+</span><span style="color:#bbb"> </span>storedValue.<span style="color:#00c">getStringValue</span>().<span style="color:#00c">length</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#333">+</span><span style="color:#bbb"> </span><span style="background-color:#fff0f0">&#34; characters) to store&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>storedFieldsConsumer.<span style="color:#00c">writeField</span>(pf.<span style="color:#00c">fieldInfo</span>,<span style="color:#bbb"> </span>storedValue);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">catch</span><span style="color:#bbb"> </span>(Throwable<span style="color:#bbb"> </span>th)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>onAbortingException(th);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#080;font-weight:bold">throw</span><span style="color:#bbb"> </span>th;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">// skip...</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#339;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">writeField</span>(FieldInfo<span style="color:#bbb"> </span>info,<span style="color:#bbb"> </span>StoredValue<span style="color:#bbb"> </span>value)<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">switch</span><span style="color:#bbb"> </span>(value.<span style="color:#00c">getType</span>())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">case</span><span style="color:#bbb"> </span>INTEGER<span style="color:#bbb"> </span><span style="color:#333">-&gt;</span><span style="color:#bbb"> </span>writer.<span style="color:#00c">writeField</span>(info,<span style="color:#bbb"> </span>value.<span style="color:#00c">getIntValue</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">case</span><span style="color:#bbb"> </span>LONG<span style="color:#bbb"> </span><span style="color:#333">-&gt;</span><span style="color:#bbb"> </span>writer.<span style="color:#00c">writeField</span>(info,<span style="color:#bbb"> </span>value.<span style="color:#00c">getLongValue</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">case</span><span style="color:#bbb"> </span>FLOAT<span style="color:#bbb"> </span><span style="color:#333">-&gt;</span><span style="color:#bbb"> </span>writer.<span style="color:#00c">writeField</span>(info,<span style="color:#bbb"> </span>value.<span style="color:#00c">getFloatValue</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">case</span><span style="color:#bbb"> </span>DOUBLE<span style="color:#bbb"> </span><span style="color:#333">-&gt;</span><span style="color:#bbb"> </span>writer.<span style="color:#00c">writeField</span>(info,<span style="color:#bbb"> </span>value.<span style="color:#00c">getDoubleValue</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">case</span><span style="color:#bbb"> </span>BINARY<span style="color:#bbb"> </span><span style="color:#333">-&gt;</span><span style="color:#bbb"> </span>writer.<span style="color:#00c">writeField</span>(info,<span style="color:#bbb"> </span>value.<span style="color:#00c">getBinaryValue</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">case</span><span style="color:#bbb"> </span>STRING<span style="color:#bbb"> </span><span style="color:#333">-&gt;</span><span style="color:#bbb"> </span>writer.<span style="color:#00c">writeField</span>(info,<span style="color:#bbb"> </span>value.<span style="color:#00c">getStringValue</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">default</span><span style="color:#bbb"> </span><span style="color:#333">-&gt;</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">new</span><span style="color:#bbb"> </span>AssertionError();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>We can see that when processing the forward index, we use <code>writeField</code> to process each field in the document.</p>
<p>Let&rsquo;s see how Lucene handles fixed-length and variable-length fields.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">writeField</span>(FieldInfo<span style="color:#bbb"> </span>info,<span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">double</span><span style="color:#bbb"> </span>value)<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#333">++</span>numStoredFieldsInDoc;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">long</span><span style="color:#bbb"> </span>infoAndBits<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>(((<span style="color:#339;font-weight:bold">long</span>)<span style="color:#bbb"> </span>info.<span style="color:#00c">number</span>)<span style="color:#bbb"> </span><span style="color:#333">&lt;&lt;</span><span style="color:#bbb"> </span>TYPE_BITS)<span style="color:#bbb"> </span><span style="color:#333">|</span><span style="color:#bbb"> </span>NUMERIC_DOUBLE;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>bufferedDocs.<span style="color:#00c">writeVLong</span>(infoAndBits);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>writeZDouble(bufferedDocs,<span style="color:#bbb"> </span>value);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">writeField</span>(FieldInfo<span style="color:#bbb"> </span>info,<span style="color:#bbb"> </span>BytesRef<span style="color:#bbb"> </span>value)<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#333">++</span>numStoredFieldsInDoc;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">long</span><span style="color:#bbb"> </span>infoAndBits<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>(((<span style="color:#339;font-weight:bold">long</span>)<span style="color:#bbb"> </span>info.<span style="color:#00c">number</span>)<span style="color:#bbb"> </span><span style="color:#333">&lt;&lt;</span><span style="color:#bbb"> </span>TYPE_BITS)<span style="color:#bbb"> </span><span style="color:#333">|</span><span style="color:#bbb"> </span>BYTE_ARR;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>bufferedDocs.<span style="color:#00c">writeVLong</span>(infoAndBits);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>bufferedDocs.<span style="color:#00c">writeVInt</span>(value.<span style="color:#00c">length</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>bufferedDocs.<span style="color:#00c">writeBytes</span>(value.<span style="color:#00c">bytes</span>,<span style="color:#bbb"> </span>value.<span style="color:#00c">offset</span>,<span style="color:#bbb"> </span>value.<span style="color:#00c">length</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>The common point is that every time a field is written, <code>numStoredFieldsInDoc++</code>. This variable is easy to understand, recording how many fields are stored in this document. Then it adds the relevant information of this field to <code>bufferedDocs</code> (which can be considered as a memory array).</p>
<p>The relevant information of the field can be considered to have three types:</p>
<ol>
<li>Field number (each field has a unique number)</li>
<li>Field data type</li>
<li>Field data, that is, the value of the field.</li>
</ol>
<p>Because the data type of the field is only a few limited types, Lucene will store it with the field number as a long type</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#080;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">long</span><span style="color:#bbb"> </span>infoAndBits<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>(((<span style="color:#339;font-weight:bold">long</span>)<span style="color:#bbb"> </span>info.<span style="color:#00c">number</span>)<span style="color:#bbb"> </span><span style="color:#333">&lt;&lt;</span><span style="color:#bbb"> </span>TYPE_BITS)<span style="color:#bbb"> </span><span style="color:#333">|</span><span style="color:#bbb"> </span>NUMERIC_DOUBLE;<span style="color:#bbb">
</span></span></span></code></pre></div><p>When the field is of fixed length, we will directly write it into <code>bufferedDocs</code>. But when the field is variable length, we will first write the number of bytes occupied by this value into <code>bufferedDocs</code>, and then write this value into <code>bufferedDocs</code>.</p>
<div style="text-align: center">
<img src="/pic/lucene-forward/bufferedDocs.png"/>
</div>
<p>After processing all the fields in each document, we can consider that we have buffered this document in memory, and then we need to finalize the forward index, that is, flush it to the disk. The function for finalizing the forward index of the document is <code>finishDocument</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">finishDocument</span>()<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">if</span><span style="color:#bbb"> </span>(numBufferedDocs<span style="color:#bbb"> </span><span style="color:#333">==</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">this</span>.<span style="color:#00c">numStoredFields</span>.<span style="color:#00c">length</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>newLength<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>ArrayUtil.<span style="color:#00c">oversize</span>(numBufferedDocs<span style="color:#bbb"> </span><span style="color:#333">+</span><span style="color:#bbb"> </span>1,<span style="color:#bbb"> </span>4);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">this</span>.<span style="color:#00c">numStoredFields</span><span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>ArrayUtil.<span style="color:#00c">growExact</span>(<span style="color:#080;font-weight:bold">this</span>.<span style="color:#00c">numStoredFields</span>,<span style="color:#bbb"> </span>newLength);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>endOffsets<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>ArrayUtil.<span style="color:#00c">growExact</span>(endOffsets,<span style="color:#bbb"> </span>newLength);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">this</span>.<span style="color:#00c">numStoredFields</span><span style="color:#333">[</span>numBufferedDocs<span style="color:#333">]</span><span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>numStoredFieldsInDoc;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>numStoredFieldsInDoc<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>endOffsets<span style="color:#333">[</span>numBufferedDocs<span style="color:#333">]</span><span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>Math.<span style="color:#00c">toIntExact</span>(bufferedDocs.<span style="color:#00c">size</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#333">++</span>numBufferedDocs;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">if</span><span style="color:#bbb"> </span>(triggerFlush())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>flush(<span style="color:#080;font-weight:bold">false</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>In this function, we will find that it does four things:</p>
<ol>
<li>Record the number of fields that need to be stored in each document and save it in the array <code>numStoredFields</code>.</li>
<li>Record the write-in position of the last byte of this document and save it in the array <code>endOffsets</code>.</li>
<li>Record the number of documents currently stored in memory, saved in the variable <code>numBufferedDocs</code>.</li>
<li>Determine whether it is necessary to flush the documents in memory to the disk. If a flush is needed, it is performed.</li>
</ol>
<div style="text-align: center">
<img src="/pic/lucene-forward/finishDocument1.png"/>
</div>
<p>By the above diagram and code, we should have understood the first three points. Next, we will focus on the fourth point.</p>
<h3 id="when-to-flush-to-disk">When to Flush to Disk</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#080;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">boolean</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">triggerFlush</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">return</span><span style="color:#bbb"> </span>bufferedDocs.<span style="color:#00c">size</span>()<span style="color:#bbb"> </span><span style="color:#333">&gt;=</span><span style="color:#bbb"> </span>chunkSize<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#333">||</span><span style="color:#bbb"> </span><span style="color:#888">// chunks of at least chunkSize bytes</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>numBufferedDocs<span style="color:#bbb"> </span><span style="color:#333">&gt;=</span><span style="color:#bbb"> </span>maxDocsPerChunk;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>From the code, we can see that when the number of Docs cached in memory <strong>reaches a threshold</strong> or the Docs <strong>memory usage reaches a threshold</strong>, both will trigger the operation of flushing to disk.</p>
<h3 id="flushing-to-disk">Flushing to Disk</h3>
<p>From here, we start to really understand how Lucene saves its forward data on the disk. Let&rsquo;s assume that we have cached three documents in memory.</p>
<div style="text-align: center">
<img src="/pic/lucene-forward/flush-overview.png"/>
</div>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#080;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">flush</span>(<span style="color:#339;font-weight:bold">boolean</span><span style="color:#bbb"> </span>force)<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">// skip...</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>numChunks<span style="color:#333">++</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">   
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">// skip...</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">// transform end offsets into lengths</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">int</span><span style="color:#333">[]</span><span style="color:#bbb"> </span>lengths<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>endOffsets;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>numBufferedDocs<span style="color:#bbb"> </span><span style="color:#333">-</span><span style="color:#bbb"> </span>1;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#333">&gt;</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span><span style="color:#333">--</span>i)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>lengths<span style="color:#333">[</span>i<span style="color:#333">]</span><span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>endOffsets<span style="color:#333">[</span>i<span style="color:#333">]</span><span style="color:#bbb"> </span><span style="color:#333">-</span><span style="color:#bbb"> </span>endOffsets<span style="color:#333">[</span>i<span style="color:#bbb"> </span><span style="color:#333">-</span><span style="color:#bbb"> </span>1<span style="color:#333">]</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">assert</span><span style="color:#bbb"> </span>lengths<span style="color:#333">[</span>i<span style="color:#333">]</span><span style="color:#bbb"> </span><span style="color:#333">&gt;=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">boolean</span><span style="color:#bbb"> </span>sliced<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>bufferedDocs.<span style="color:#00c">size</span>()<span style="color:#bbb"> </span><span style="color:#333">&gt;=</span><span style="color:#bbb"> </span>2L<span style="color:#bbb"> </span><span style="color:#333">*</span><span style="color:#bbb"> </span>chunkSize;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">boolean</span><span style="color:#bbb"> </span>dirtyChunk<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>force;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">// skip...</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>From the code, we can see that before actually writing to the disk, we still need to do some calculations in memory:</p>
<ol>
<li>Increment the number of chunks written to the disk.</li>
<li>Convert the previously saved position of the last byte of each document (endOffsets) into the length of each document.</li>
<li>Determine whether to slice, sliced.</li>
<li>Determine whether it is a dirtyChunk.</li>
</ol>
<p>The last two points can be ignored for now, just understand the first two.</p>
<p>The files we need to write to the disk are five in total:</p>
<ol>
<li>fdt</li>
<li>fdm</li>
<li>fdx</li>
<li>seg-xx-doc_ids</li>
<li>seg-xx-file_pointers</li>
</ol>
<p>Among them, 4 and 5 are temporary files and will not appear in the final index file. They only serve the task of temporarily storing data. The specific values of each variable in memory and the disk files that need to be written can be seen in the following figure.</p>
<div style="text-align: center">
<img src="/pic/lucene-forward/wait-to-flush.png"/>
</div>
<p>First, we will write the number of documents saved in this chunk and the starting position of this chunk in the fdt file to the files seg-xx-doc_ids and seg-xx-file_pointers.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#080;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">flush</span>(<span style="color:#339;font-weight:bold">boolean</span><span style="color:#bbb"> </span>force)<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">// skip...</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>indexWriter.<span style="color:#00c">writeIndex</span>(numBufferedDocs,<span style="color:#bbb"> </span>fieldsStream.<span style="color:#00c">getFilePointer</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">//skip...</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#339;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">writeIndex</span>(<span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>numDocs,<span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">long</span><span style="color:#bbb"> </span>startPointer)<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">assert</span><span style="color:#bbb"> </span>startPointer<span style="color:#bbb"> </span><span style="color:#333">&gt;=</span><span style="color:#bbb"> </span>previousFP;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>docsOut.<span style="color:#00c">writeVInt</span>(numDocs);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>filePointersOut.<span style="color:#00c">writeVLong</span>(startPointer<span style="color:#bbb"> </span><span style="color:#333">-</span><span style="color:#bbb"> </span>previousFP);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>previousFP<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>startPointer;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>totalDocs<span style="color:#bbb"> </span><span style="color:#333">+=</span><span style="color:#bbb"> </span>numDocs;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>totalChunks<span style="color:#333">++</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>We notice that when writing filePointers, we store not the actual value but the difference. This is because filePointers is definitely a continuously increasing array. In this case, storing the difference can make the elements actually stored smaller than the original value, which is conducive to compression. Imagine that <strong>the number of bits required to store 100000 is much greater than the number of bits required to store 3</strong>.</p>
<p>The state after writing the files seg-xx-doc_ids and seg-xx-file_pointers is as shown in the following figure.</p>
<div style="text-align: center">
<img src="/pic/lucene-forward/index-writer.png"/>
</div>
<p>After writing the files seg-xx-doc_ids and seg-xx-file_pointers, we need to write the cached document content into the fdt file.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#080;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">flush</span>(<span style="color:#339;font-weight:bold">boolean</span><span style="color:#bbb"> </span>force)<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">// skip...</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>writeHeader(docBase,<span style="color:#bbb"> </span>numBufferedDocs,<span style="color:#bbb"> </span>numStoredFields,<span style="color:#bbb"> </span>lengths,<span style="color:#bbb"> </span>sliced,<span style="color:#bbb"> </span>dirtyChunk);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">//skip...</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">if</span><span style="color:#bbb"> </span>(sliced)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#888">// big chunk, slice it, using ByteBuffersDataInput ignore memory copy</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>capacity<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>(<span style="color:#339;font-weight:bold">int</span>)<span style="color:#bbb"> </span>bytebuffers.<span style="color:#00c">size</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>compressed<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>compressed<span style="color:#bbb"> </span><span style="color:#333">&lt;</span><span style="color:#bbb"> </span>capacity;<span style="color:#bbb"> </span>compressed<span style="color:#bbb"> </span><span style="color:#333">+=</span><span style="color:#bbb"> </span>chunkSize)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>l<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>Math.<span style="color:#00c">min</span>(chunkSize,<span style="color:#bbb"> </span>capacity<span style="color:#bbb"> </span><span style="color:#333">-</span><span style="color:#bbb"> </span>compressed);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>ByteBuffersDataInput<span style="color:#bbb"> </span>bbdi<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>bytebuffers.<span style="color:#00c">slice</span>(compressed,<span style="color:#bbb"> </span>l);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>compressor.<span style="color:#00c">compress</span>(bbdi,<span style="color:#bbb"> </span>fieldsStream);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>compressor.<span style="color:#00c">compress</span>(bytebuffers,<span style="color:#bbb"> </span>fieldsStream);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#080;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">writeHeader</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>docBase,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>numBufferedDocs,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#339;font-weight:bold">int</span><span style="color:#333">[]</span><span style="color:#bbb"> </span>numStoredFields,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#339;font-weight:bold">int</span><span style="color:#333">[]</span><span style="color:#bbb"> </span>lengths,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#339;font-weight:bold">boolean</span><span style="color:#bbb"> </span>sliced,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#339;font-weight:bold">boolean</span><span style="color:#bbb"> </span>dirtyChunk)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>slicedBit<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>sliced<span style="color:#bbb"> </span><span style="color:#333">?</span><span style="color:#bbb"> </span>1<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>dirtyBit<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>dirtyChunk<span style="color:#bbb"> </span><span style="color:#333">?</span><span style="color:#bbb"> </span>2<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">// save docBase and numBufferedDocs</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>fieldsStream.<span style="color:#00c">writeVInt</span>(docBase);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>fieldsStream.<span style="color:#00c">writeVInt</span>((numBufferedDocs<span style="color:#bbb"> </span><span style="color:#333">&lt;&lt;</span><span style="color:#bbb"> </span>2)<span style="color:#bbb"> </span><span style="color:#333">|</span><span style="color:#bbb"> </span>dirtyBit<span style="color:#bbb"> </span><span style="color:#333">|</span><span style="color:#bbb"> </span>slicedBit);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">// save numStoredFields</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>saveInts(numStoredFields,<span style="color:#bbb"> </span>numBufferedDocs,<span style="color:#bbb"> </span>fieldsStream);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">// save lengths</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>saveInts(lengths,<span style="color:#bbb"> </span>numBufferedDocs,<span style="color:#bbb"> </span>fieldsStream);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>We can see that we will write <code>docBase</code>, <code>numBufferedDocs</code>, <code>dirtyBit</code>, <code>slicedBit</code>, <code>numStoredFields</code>, <code>lengths</code>, and <code>bufferedDocs</code> into fdt.</p>
<ol>
<li><code>docBase</code> is the first <code>DocID</code> of this chunk.</li>
<li><code>numBufferedDocs</code> is the total number of Docs cached in this chunk.</li>
<li><code>dirtyBit</code>, <code>slicedBit</code> can be ignored for now.</li>
<li>The array <code>numStoredFields</code> is the number of fields to be stored for each Doc.</li>
<li>The array <code>lengths</code> is the length of each Doc.</li>
<li>The array <code>bufferedDocs</code> is the actual stored data of all Docs.</li>
</ol>
<p>The state after writing fdt is as shown in the following figure.</p>
<div style="text-align: center">
<img src="/pic/lucene-forward/fdt.png"/>
</div>
<p>The function <code>flush</code> has been fully introduced. This is how Lucene processes one Doc after another, first caching them in memory, and then flushing them to the disk when a certain number is cached.</p>
<h3 id="generating-the-final-index-file">Generating the Final Index File</h3>
<p>When Lucene has processed all the documents, it will call <code>finish</code> to generate the final index file.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">finish</span>(<span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>numDocs)<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">if</span><span style="color:#bbb"> </span>(numBufferedDocs<span style="color:#bbb"> </span><span style="color:#333">&gt;</span><span style="color:#bbb"> </span>0)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>flush(<span style="color:#080;font-weight:bold">true</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">assert</span><span style="color:#bbb"> </span>bufferedDocs.<span style="color:#00c">size</span>()<span style="color:#bbb"> </span><span style="color:#333">==</span><span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">if</span><span style="color:#bbb"> </span>(docBase<span style="color:#bbb"> </span><span style="color:#333">!=</span><span style="color:#bbb"> </span>numDocs)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">new</span><span style="color:#bbb"> </span>RuntimeException(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="background-color:#fff0f0">&#34;Wrote &#34;</span><span style="color:#bbb"> </span><span style="color:#333">+</span><span style="color:#bbb"> </span>docBase<span style="color:#bbb"> </span><span style="color:#333">+</span><span style="color:#bbb"> </span><span style="background-color:#fff0f0">&#34; docs, finish called with numDocs=&#34;</span><span style="color:#bbb"> </span><span style="color:#333">+</span><span style="color:#bbb"> </span>numDocs);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>indexWriter.<span style="color:#00c">finish</span>(numDocs,<span style="color:#bbb"> </span>fieldsStream.<span style="color:#00c">getFilePointer</span>(),<span style="color:#bbb"> </span>metaStream);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>metaStream.<span style="color:#00c">writeVLong</span>(numChunks);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>metaStream.<span style="color:#00c">writeVLong</span>(numDirtyChunks);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>metaStream.<span style="color:#00c">writeVLong</span>(numDirtyDocs);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>CodecUtil.<span style="color:#00c">writeFooter</span>(metaStream);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>CodecUtil.<span style="color:#00c">writeFooter</span>(fieldsStream);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">assert</span><span style="color:#bbb"> </span>bufferedDocs.<span style="color:#00c">size</span>()<span style="color:#bbb"> </span><span style="color:#333">==</span><span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>We can now understand what <code>dirty</code> means in <code>flush</code>. When
the Docs cached in memory have not reached the flush condition, but the documents have been fully processed, we need to forcibly flush them to the disk. In this case, we will set <code>dirty</code> to <code>true</code>. As for <code>sliced</code>, it is because if the length of <code>bufferedDocs</code> is very large, in order to ensure the effect of compression, we will slice it, compress the slices, and write them to the fdt file.</p>
<p>After flushing all the cached Docs to the disk, we start generating the fdx and fdm files.
We first focus on <code>indexWriter.finish(numDocs, fieldsStream.getFilePointer(), metaStream);</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#339;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">finish</span>(<span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>numDocs,<span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">long</span><span style="color:#bbb"> </span>maxPointer,<span style="color:#bbb"> </span>IndexOutput<span style="color:#bbb"> </span>metaOut)<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">if</span><span style="color:#bbb"> </span>(numDocs<span style="color:#bbb"> </span><span style="color:#333">!=</span><span style="color:#bbb"> </span>totalDocs)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">new</span><span style="color:#bbb"> </span>IllegalStateException(<span style="background-color:#fff0f0">&#34;Expected &#34;</span><span style="color:#bbb"> </span><span style="color:#333">+</span><span style="color:#bbb"> </span>numDocs<span style="color:#bbb"> </span><span style="color:#333">+</span><span style="color:#bbb"> </span><span style="background-color:#fff0f0">&#34; docs, but got &#34;</span><span style="color:#bbb"> </span><span style="color:#333">+</span><span style="color:#bbb"> </span>totalDocs);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>CodecUtil.<span style="color:#00c">writeFooter</span>(docsOut);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>CodecUtil.<span style="color:#00c">writeFooter</span>(filePointersOut);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>IOUtils.<span style="color:#00c">close</span>(docsOut,<span style="color:#bbb"> </span>filePointersOut);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">// skip...</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>Lucene will first write a <code>Footer</code> to the files seg-xx-doc_ids and seg-xx-file_pointers to mark the completion of writing. Also, the <code>Footer</code> can protect the integrity of the file.</p>
<div style="text-align: center">
<img src="/pic/lucene-forward/temp-footer.png"/>
</div>
<p>Then we will write into fdx and fdm.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#339;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">finish</span>(<span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>numDocs,<span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">long</span><span style="color:#bbb"> </span>maxPointer,<span style="color:#bbb"> </span>IndexOutput<span style="color:#bbb"> </span>metaOut)<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">//skip...</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">try</span><span style="color:#bbb"> </span>(IndexOutput<span style="color:#bbb"> </span>dataOut<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>dir.<span style="color:#00c">createOutput</span>(IndexFileNames.<span style="color:#00c">segmentFileName</span>(name,<span style="color:#bbb"> </span>suffix,<span style="color:#bbb"> </span>extension),<span style="color:#bbb"> </span>ioContext))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>CodecUtil.<span style="color:#00c">writeIndexHeader</span>(dataOut,<span style="color:#bbb"> </span>codecName<span style="color:#bbb"> </span><span style="color:#333">+</span><span style="color:#bbb"> </span><span style="background-color:#fff0f0">&#34;Idx&#34;</span>,<span style="color:#bbb"> </span>VERSION_CURRENT,<span style="color:#bbb"> </span>id,<span style="color:#bbb"> </span>suffix);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>metaOut.<span style="color:#00c">writeInt</span>(numDocs);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>metaOut.<span style="color:#00c">writeInt</span>(blockShift);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>metaOut.<span style="color:#00c">writeInt</span>(totalChunks<span style="color:#bbb"> </span><span style="color:#333">+</span><span style="color:#bbb"> </span>1);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>metaOut.<span style="color:#00c">writeLong</span>(dataOut.<span style="color:#00c">getFilePointer</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">try</span><span style="color:#bbb"> </span>(ChecksumIndexInput<span style="color:#bbb"> </span>docsIn<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>dir.<span style="color:#00c">openChecksumInput</span>(docsOut.<span style="color:#00c">getName</span>()))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>CodecUtil.<span style="color:#00c">checkHeader</span>(docsIn,<span style="color:#bbb"> </span>codecName<span style="color:#bbb"> </span><span style="color:#333">+</span><span style="color:#bbb"> </span><span style="background-color:#fff0f0">&#34;Docs&#34;</span>,<span style="color:#bbb"> </span>VERSION_CURRENT,<span style="color:#bbb"> </span>VERSION_CURRENT);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Throwable<span style="color:#bbb"> </span>priorE<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">null</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#080;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#080;font-weight:bold">final</span><span style="color:#bbb"> </span>DirectMonotonicWriter<span style="color:#bbb"> </span>docs<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span>DirectMonotonicWriter.<span style="color:#00c">getInstance</span>(metaOut,<span style="color:#bbb"> </span>dataOut,<span style="color:#bbb"> </span>totalChunks<span style="color:#bbb"> </span><span style="color:#333">+</span><span style="color:#bbb"> </span>1,<span style="color:#bbb"> </span>blockShift);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#339;font-weight:bold">long</span><span style="color:#bbb"> </span>doc<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>docs.<span style="color:#00c">add</span>(doc);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#080;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#333">&lt;</span><span style="color:#bbb"> </span>totalChunks;<span style="color:#bbb"> </span><span style="color:#333">++</span>i)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>doc<span style="color:#bbb"> </span><span style="color:#333">+=</span><span style="color:#bbb"> </span>docsIn.<span style="color:#00c">readVInt</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>docs.<span style="color:#00c">add</span>(doc);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>docs.<span style="color:#00c">finish</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#080;font-weight:bold">if</span><span style="color:#bbb"> </span>(doc<span style="color:#bbb"> </span><span style="color:#333">!=</span><span style="color:#bbb"> </span>totalDocs)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#080;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">new</span><span style="color:#bbb"> </span>CorruptIndexException(<span style="background-color:#fff0f0">&#34;Docs don&#39;t add up&#34;</span>,<span style="color:#bbb"> </span>docsIn);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">catch</span><span style="color:#bbb"> </span>(Throwable<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>priorE<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>e;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">finally</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>CodecUtil.<span style="color:#00c">checkFooter</span>(docsIn,<span style="color:#bbb"> </span>priorE);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>dir.<span style="color:#00c">deleteFile</span>(docsOut.<span style="color:#00c">getName</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>docsOut<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">null</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>metaOut.<span style="color:#00c">writeLong</span>(dataOut.<span style="color:#00c">getFilePointer</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#080;font-weight:bold">try</span><span style="color:#bbb"> </span>(ChecksumIndexInput<span style="color:#bbb"> </span>filePointersIn<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>dir.<span style="color:#00c">openChecksumInput</span>(filePointersOut.<span style="color:#00c">getName</span>()))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>CodecUtil.<span style="color:#00c">checkHeader</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>filePointersIn,<span style="color:#bbb"> </span>codecName<span style="color:#bbb"> </span><span style="color:#333">+</span><span style="color:#bbb"> </span><span style="background-color:#fff0f0">&#34;FilePointers&#34;</span>,<span style="color:#bbb"> </span>VERSION_CURRENT,<span style="color:#bbb"> </span>VERSION_CURRENT);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Throwable<span style="color:#bbb"> </span>priorE<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">null</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#080;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#080;font-weight:bold">final</span><span style="color:#bbb"> </span>DirectMonotonicWriter<span style="color:#bbb"> </span>filePointers<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span>DirectMonotonicWriter.<span style="color:#00c">getInstance</span>(metaOut,<span style="color:#bbb"> </span>dataOut,<span style="color:#bbb"> </span>totalChunks<span style="color:#bbb"> </span><span style="color:#333">+</span><span style="color:#bbb"> </span>1,<span style="color:#bbb"> </span>blockShift);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#339;font-weight:bold">long</span><span style="color:#bbb"> </span>fp<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#080;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#333">&lt;</span><span style="color:#bbb"> </span>totalChunks;<span style="color:#bbb"> </span><span style="color:#333">++</span>i)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>fp<span style="color:#bbb"> </span><span style="color:#333">+=</span><span style="color:#bbb"> </span>filePointersIn.<span style="color:#00c">readVLong</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>filePointers.<span style="color:#00c">add</span>(fp);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#080;font-weight:bold">if</span><span style="color:#bbb"> </span>(maxPointer<span style="color:#bbb"> </span><span style="color:#333">&lt;</span><span style="color:#bbb"> </span>fp)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#080;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">new</span><span style="color:#bbb"> </span>CorruptIndexException(<span style="background-color:#fff0f0">&#34;File pointers don&#39;t add up&#34;</span>,<span style="color:#bbb"> </span>filePointersIn);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>filePointers.<span style="color:#00c">add</span>(maxPointer);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>filePointers.<span style="color:#00c">finish</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">catch</span><span style="color:#bbb"> </span>(Throwable<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>priorE<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span>e;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">finally</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>CodecUtil.<span style="color:#00c">checkFooter</span>(filePointersIn,<span style="color:#bbb"> </span>priorE);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>dir.<span style="color:#00c">deleteFile</span>(filePointersOut.<span style="color:#00c">getName</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>filePointersOut<span style="color:#bbb"> </span><span style="color:#333">=</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">null</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>metaOut.<span style="color:#00c">writeLong</span>(dataOut.<span style="color:#00c">getFilePointer</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>metaOut.<span style="color:#00c">writeLong</span>(maxPointer);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>CodecUtil.<span style="color:#00c">writeFooter</span>(dataOut);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>We will first write <code>numDocs</code>, <code>blockShift</code>, <code>totalChunks+1</code>, <code>dataOut.getFilePointer()</code> into fdm:</p>
<ol>
<li><code>numDocs</code> is the total number of docs.</li>
<li><code>blockShift</code> is the meta information used for decompression and compression.</li>
<li><code>totalChunks+1</code> is the total number of chunks plus one.</li>
<li><code>dataOut.getFilePointer()</code> is the next position to be written in the fdx file.</li>
</ol>
<p>Then we compress the content saved in the file seg-xx-doc_ids and write it into the fdx file, and write the meta information needed for decompression into fdm, and finally write the next position to be written in fdm into fdm.
The same way, compress the content saved in the file seg-xx-file_pointers and write it into the fdx file, and write the meta information needed for decompression into fdm, and finally write the next position to be written in fdm and fdt into fdm.
The final state is as shown in the following figure.</p>
<div style="text-align: center">
<img src="/pic/lucene-forward/fdx-finish.png"/>
</div>
From the diagram, we notice that the `chunkSize` after the `Header` of fdm is not reflected in the above code. This is because this variable is written when fdm is created.
<p>After completing the above steps, we only need to write <code>numChunks</code>, <code>numDirtyChunks</code>, <code>numDirtyDocs</code> into fdm.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#339;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">finish</span>(<span style="color:#339;font-weight:bold">int</span><span style="color:#bbb"> </span>numDocs)<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">//skip...</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>metaStream.<span style="color:#00c">writeVLong</span>(numChunks);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>metaStream.<span style="color:#00c">writeVLong</span>(numDirtyChunks);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>metaStream.<span style="color:#00c">writeVLong</span>(numDirtyDocs);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>CodecUtil.<span style="color:#00c">writeFooter</span>(metaStream);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>CodecUtil.<span style="color:#00c">writeFooter</span>(fieldsStream);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">assert</span><span style="color:#bbb"> </span>bufferedDocs.<span style="color:#00c">size</span>()<span style="color:#bbb"> </span><span style="color:#333">==</span><span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>Finally, the complete index file is as shown in the following figure.</p>
<div style="text-align: center">
<img src="/pic/lucene-forward/finish-write.png"/>
</div>
<h3 id="overview">Overview</h3>
<p>Finally, here is a schematic diagram of the index file and its relationships.</p>
<div style="text-align: center">
<img src="/pic/lucene-forward/overview.png"/>
</div>
</div>
<div class="tags">
<div class="taxosfloating_left">
<p>Categories</p>
</div>
<div class="termsfloating_right">
<p>
<a href="/categories/full%20text%20search/">full text search</a>
<a href="/categories/lucene/">lucene</a>
</p>
</div>
<div class="clearit"></div>
</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
(function() {


if (window.location.hostname == "localhost")
  return;
var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
var disqus_shortname = 'tangdh-life';
dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to load the comments.</noscript>


</article>
</div>
</main><script src="/js/dark-mode.js"></script>

</body>
</html>
